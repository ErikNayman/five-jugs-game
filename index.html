<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Option RUO Calculator â€“Â Autoâ€‘Fill</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* simple dark chart background */
    canvas{background:#f8fafc;border-radius:12px}
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-3xl bg-white shadow-xl rounded-2xl p-8 space-y-6">
    <h1 class="text-2xl font-semibold text-center">Option RUO Calculator â€” Autoâ€‘Fill</h1>

    <!-- â•”â•â•â• AUTOâ€‘FILL SECTION â•â•â•â•— -->
    <div class="grid grid-cols-2 gap-4">
      <label class="flex flex-col col-span-2">
        <span class="text-sm">Ticker</span>
        <input id="ticker" placeholder="AAPL" class="border rounded-lg px-3 py-2 uppercase tracking-wide">
      </label>

      <label class="flex flex-col">
        <span class="text-sm">Expiration date</span>
        <select id="expSelect" class="border rounded-lg px-3 py-2"></select>
      </label>

      <label class="flex flex-col">
        <span class="text-sm">Strike</span>
        <select id="strikeSelect" class="border rounded-lg px-3 py-2"></select>
      </label>

      <label class="flex flex-col">
        <span class="text-sm">Days to expiration</span>
        <input id="days" readonly class="border rounded-lg px-3 py-2 bg-slate-100">
      </label>

      <label class="flex flex-col">
        <span class="text-sm">VolatilityÂ Ïƒ (annual, IV)</span>
        <input id="sigma" readonly class="border rounded-lg px-3 py-2 bg-slate-100">
      </label>

      <label class="flex flex-col">
        <span class="text-sm">Riskâ€‘free rateÂ r (auto FRED)</span>
        <input id="r" class="border rounded-lg px-3 py-2 bg-slate-100">
      </label>

      <label class="flex flex-col">
        <span class="text-sm">DividendÂ yieldÂ q (auto)</span>
        <input id="q" class="border rounded-lg px-3 py-2 bg-slate-100">
      </label>

      <!-- manual fineâ€‘tune fields -->
      <label class="flex flex-col">
        <span class="text-sm">Binomial priceÂ steps</span>
        <input id="priceSteps" type="number" value="200" step="10" class="border rounded-lg px-3 py-2">
      </label>
      <label class="flex flex-col">
        <span class="text-sm">RUO simulations N</span>
        <input id="N" type="number" value="35000" step="1000" class="border rounded-lg px-3 py-2">
      </label>
      <label class="flex flex-col">
        <span class="text-sm">RUO stepsÂ /Â year</span>
        <input id="steps" type="number" value="252" step="1" class="border rounded-lg px-3 py-2">
      </label>
    </div>

    <!-- IV surface button -->
    <button id="plotBtn" class="w-full bg-slate-600 hover:bg-slate-700 text-white rounded-lg py-2.5 font-medium">Show IVÂ Skew</button>
    <canvas id="ivChart" height="250" class="hidden"></canvas>

    <!-- calculate -->
    <button id="calcBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-3 font-semibold">Calculate</button>
    <div id="output" class="text-lg font-mono whitespace-pre-wrap"></div>
  </div>

<script>
const API_KEY = 'YOUR_RAPIDAPI_KEY'; // ðŸ”‘ insert your RapidAPI key (Yahoo Finance) here
const FRED_KEY = 'YOUR_FRED_KEY';    // optional: FRED api key for riskâ€‘free auto
const YH_HOST  = 'yh-finance.p.rapidapi.com';

const hdrs = {'X-RapidAPI-Key':API_KEY,'X-RapidAPI-Host':YH_HOST};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const toDateStr = ts=>new Date(ts*1000).toISOString().slice(0,10);
const todaySec = ()=>Date.now()/1000;

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ticker change â†’ expirations list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function fetchExpirations(tkr){
  const res = await fetch(`https://${YH_HOST}/options/v2/get-options?symbol=${tkr}`,{headers:hdrs});
  const js  = await res.json();
  return js.optionExpirationDates||[];
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ expiration change â†’ strikes + IV, days â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function fetchChain(tkr,ts){
  const res = await fetch(`https://${YH_HOST}/options/v2/get-options?symbol=${tkr}&date=${ts}`,{headers:hdrs});
  const js  = await res.json();
  return js.options[0]; // {calls:[], puts:[]}
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ quote for dividend yield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function fetchQuote(tkr){
  const res = await fetch(`https://${YH_HOST}/stock/v2/get-summary?symbol=${tkr}`,{headers:hdrs});
  const js  = await res.json();
  return js.summaryDetail||{};
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ riskâ€‘free from FRED (DGS3MO) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function fetchRiskFree(){
  if(!FRED_KEY) return null;
  const url = `https://api.stlouisfed.org/fred/series/observations?series_id=DGS3MO&api_key=${FRED_KEY}&file_type=json&limit=1&sort_order=desc`;
  const res = await fetch(url);
  const js  = await res.json();
  const obs = js.observations&&js.observations[0];
  return obs?parseFloat(obs.value)/100: null;
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ populate expirations on ticker input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const tickerEl = document.getElementById('ticker');
const expSel   = document.getElementById('expSelect');
const strikeSel= document.getElementById('strikeSelect');

tickerEl.addEventListener('change',async e=>{
  const tkr=e.target.value.trim().toUpperCase();
  if(!tkr) return;
  // riskâ€‘free auto
  fetchRiskFree().then(v=>{ if(v) document.getElementById('r').value=v.toFixed(4);});
  // dividend auto
  fetchQuote(tkr).then(q=>{
    const div = (q.dividendYield&&q.dividendYield.raw)||0;
    document.getElementById('q').value=div.toFixed(4);
  });
  // expirations
  const dates=await fetchExpirations(tkr);
  expSel.innerHTML='';
  dates.forEach(ts=>{
    expSel.innerHTML+=`<option value="${ts}">${toDateStr(ts)}</option>`;
  });
  expSel.dispatchEvent(new Event('change'));
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ on expiration selected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
expSel.addEventListener('change',async e=>{
  const ts=parseInt(e.target.value);
  const tkr=tickerEl.value.trim().toUpperCase();
  if(!ts||!tkr) return;
  // days until expiration
  const days=Math.max(Math.round((ts-todaySec())/86400),0);
  document.getElementById('days').value=days;
  // chain
  const chain=await fetchChain(tkr,ts);
  const calls=chain.calls||[];
  strikeSel.innerHTML='';
  calls.forEach(c=>{
    strikeSel.innerHTML += `<option value="${c.strike}" data-iv="${c.impliedVolatility}">${c.strike} (IV ${(c.impliedVolatility*100).toFixed(1)}%)</option>`;
  });
  strikeSel.dispatchEvent(new Event('change'));
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ on strike select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
strikeSel.addEventListener('change',e=>{
  const opt=e.target.selectedOptions[0];
  if(!opt) return;
  document.getElementById('K').value=opt.value;
  document.getElementById('sigma').value=parseFloat(opt.dataset.iv).toFixed(4);
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IV skew chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let chart=null;

document.getElementById('plotBtn').onclick=async()=>{
  const ts=parseInt(expSel.value);
  const tkr=tickerEl.value.trim().toUpperCase();
  if(!ts||!tkr) return;
  const chain=await fetchChain(tkr,ts);
  const calls=chain.calls||[];
  const strikes=calls.map(c=>c.strike);
  const ivs=calls.map(c=>c.impliedVolatility*100);
  const ctx=document.getElementById('ivChart');
  ctx.classList.remove('hidden');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'line',data:{labels:strikes,datasets:[{label:`IV % â€“ ${toDateStr(ts)}` ,data:ivs,fill:false}]},options:{plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'Strike'}},y:{title:{display:true,text:'IV %'}}}}});
};

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€ existing calculator logic (americanPutCRR, ruoPut, randn) â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function americanPutCRR(S,K,T,r,q,sigma,n){const dt=T/n,u=Math.exp(sigma*Math.sqrt(dt)),d=1/u,disc=Math.exp(-r*dt),p=(Math.exp((r-q)*dt)-d)/(u-d);const vals=Array(n+1);let Su=S*Math.pow(u,n);for(let i=0;i<=n;i++){vals[i]=Math.max(K-Su,0);Su*=d*d;}for(let step=n-1;step>=0;step--){for(let i=0;i<=step;i++){const cont=disc*(p*vals[i]+(1-p)*vals[i+1]);const early=Math.max(K-S*Math.pow(u,step-2*i),0);vals[i]=Math.max(cont,early);}}return vals[0];}
function randn(){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);} 
function ruoPut(S0,K,T,r,q,sigma,N,stepsPerYear){const total=Math.ceil(T*stepsPerYear),dt=T/total,drift=(r-q-0.5*sigma**2)*dt,diff=sigma*Math.sqrt(dt);let sum=0,count=0;for(let i=0;i<N;i++){let S=S0,hit=false;for(let s=0;s<total;s++){S*=Math.exp(drift+diff*randn());if(!hit&&S<=K)hit=true;}if(hit&&S>K){sum+=S-K;count++;}}return count?sum/N:0;}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ main Calculate â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.getElementById('calcBtn').onclick=()=>{
  const g=id=>parseFloat(document.getElementById(id).value);
  const S0=g('ticker')?g('S0')||parseFloat(document.getElementById('ticker').dataset.price||0):g('S0'); // fallback
  const K=g('K'), days=g('days'), sigma=g('sigma'), r=g('r'), q=g('q');
  if(!S0||!K||!days||!sigma){alert('Missing key inputs');return;}
  const N=g('N'), steps=g('steps'), nTree=g('priceSteps');
  const T=days/365;
  const amer=americanPutCRR(S0,K,T,r,q,sigma,nTree);
  const ruo=ruoPut(S0,K,T,r,q,sigma,N,steps);
  const fair=amer+ruo;
  document.getElementById('output').textContent=`American put (CRR): ${amer.toFixed(4)}\nRUO (missed-upside): ${ruo.toFixed(4)}\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nFair put premium: ${fair.toFixed(4)}`;
};
</script>
</body>
</html>
